#!/usr/bin/env ruby

require 'rubygems'
require 'optitron'

$LOAD_PATH << File.expand_path("#{File.dirname(__FILE__)}/..")
require 'lib/gusteau'

class Gusteau::CLI < Optitron::CLI
  class << self
    def nodes_list
      Dir.glob("./nodes/**/*.yml").map { |f| File.basename(f, '.*') }
    end
  end

  class_opt 'node', 'Node name', {
    :in       => nodes_list,
    :required => true
  }

  class_opt 'bootstrap', 'If needed, install chef-solo'

  desc 'Fully provision a node'
  def provision
    node(params['node']).provision(params['bootstrap'])
  end

  desc 'Run recipe(s)'
  def run(*recipe)
    node(params['node']).run(params['bootstrap'], recipe)
  end

  private

  def node(node_name)
    node_path = Dir.glob("./nodes/**/#{node_name}.yml")[0]
    Gusteau::Node.new(node_path)
  end
end

Gusteau::CLI.dispatch
